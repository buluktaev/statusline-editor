<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Statusline Editor v2</title>
  <style>
    :root {
      --bg: #1a1a1a;
      --bg2: #222222;
      --bg3: #2a2a2a;
      --bg4: #333333;
      --border: #3a3a3a;
      --text: #d4d4d4;
      --text-dim: #888888;
      --accent: #e8814d;
      --accent-dim: #7a3f20;
      --green: #4ec94e;
      --yellow: #e8c44d;
      --red: #e84d4d;
      --font: 'JetBrains Mono', 'Fira Code', 'Cascadia Code', monospace;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--font);
      font-size: 13px;
      min-height: 100vh;
    }

    #app {
      max-width: 1100px;
      margin: 0 auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    
    #header h1 {
      font-size: 14px;
      font-weight: 600;
      color: var(--accent);
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }
    .btn-group { display: flex; gap: 8px; }
    .btn {
      padding: 6px 14px;
      background: var(--bg3);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      font-family: var(--font);
      font-size: 12px;
      cursor: pointer;
      transition: background 0.15s, border-color 0.15s;
    }
    .btn:hover { background: var(--bg4); border-color: var(--accent-dim); }
    .btn-primary {
      background: var(--accent-dim);
      border-color: var(--accent);
      color: var(--accent);
    }
    .btn-primary:hover { background: var(--accent); color: #1a1a1a; }

    .preview-wrap { display: flex; flex-direction: column; gap: 4px; }
    #preview-label {
      font-size: 10px;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }
    #preview {
      padding: 14px 18px;
      background: #0d0d0d;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 13px;
      min-height: 44px;
      display: flex;
      align-items: center;
      letter-spacing: 0.02em;
    }

    #editor {
      display: grid;
      grid-template-columns: 220px 1fr;
      gap: 12px;
      min-height: 420px;
    }

    #blocks {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .panel-label {
      font-size: 10px;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-bottom: 8px;
    }

    .block-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      background: var(--bg3);
      border: 1px solid transparent;
      border-radius: 4px;
      cursor: pointer;
      user-select: none;
      transition: background 0.1s, border-color 0.1s;
    }
    .block-item:hover { background: var(--bg4); }
    .block-item.active { border-color: var(--accent); background: var(--bg4); }
    .block-item.drag-over { border-color: var(--accent); opacity: 0.7; }
    .drag-handle {
      color: var(--text-dim);
      cursor: grab;
      font-size: 14px;
      line-height: 1;
      flex-shrink: 0;
    }
    .drag-handle:active { cursor: grabbing; }
    .block-toggle {
      width: 16px;
      height: 16px;
      border: 1px solid var(--border);
      border-radius: 3px;
      background: var(--bg);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      font-size: 10px;
      transition: background 0.1s, border-color 0.1s;
    }
    .block-toggle.on { background: var(--accent); border-color: var(--accent); color: #1a1a1a; }
    .block-name { flex: 1; font-size: 12px; }
    .block-item.disabled .block-name { color: var(--text-dim); }

    #settings {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 16px;
      overflow-y: auto;
    }
    #settings-content { display: flex; flex-direction: column; gap: 16px; }
    .settings-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border);
    }
    .setting-row { display: flex; flex-direction: column; gap: 6px; }
    .setting-label {
      font-size: 11px;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .toggle-wrap { display: flex; align-items: center; gap: 10px; }
    .toggle { position: relative; width: 36px; height: 20px; cursor: pointer; }
    .toggle input { opacity: 0; width: 0; height: 0; }
    .toggle-slider {
      position: absolute;
      inset: 0;
      background: var(--bg4);
      border: 1px solid var(--border);
      border-radius: 10px;
      transition: background 0.2s;
    }
    .toggle-slider::before {
      content: '';
      position: absolute;
      width: 14px;
      height: 14px;
      left: 2px;
      top: 2px;
      background: var(--text-dim);
      border-radius: 50%;
      transition: transform 0.2s, background 0.2s;
    }
    .toggle input:checked + .toggle-slider { background: var(--accent-dim); border-color: var(--accent); }
    .toggle input:checked + .toggle-slider::before { transform: translateX(16px); background: var(--accent); }
    .toggle-text { font-size: 12px; }

    .segment { display: flex; gap: 4px; flex-wrap: wrap; }
    .segment-btn {
      padding: 5px 12px;
      background: var(--bg3);
      border: 1px solid var(--border);
      border-radius: 4px;
      font-family: var(--font);
      font-size: 12px;
      color: var(--text-dim);
      cursor: pointer;
      transition: background 0.1s, border-color 0.1s, color 0.1s;
    }
    .segment-btn:hover { background: var(--bg4); color: var(--text); }
    .segment-btn.active { background: var(--accent-dim); border-color: var(--accent); color: var(--accent); }

    .style-cards { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
    .style-card {
      padding: 12px 8px;
      background: var(--bg3);
      border: 2px solid var(--border);
      border-radius: 6px;
      cursor: pointer;
      text-align: center;
      transition: border-color 0.15s, background 0.15s;
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: center;
    }
    .style-card:hover { background: var(--bg4); }
    .style-card.active { border-color: var(--accent); background: var(--bg4); }
    .style-card-preview { font-size: 14px; letter-spacing: 0.05em; min-height: 20px; display: flex; align-items: center; }
    .style-card-name { font-size: 10px; color: var(--text-dim); }

    .color-picker-wrap { display: flex; flex-direction: column; gap: 8px; }
    .color-swatch { width: 24px; height: 24px; border-radius: 4px; border: 2px solid var(--border); cursor: pointer; display: inline-block; }
    .color-preview-row { display: flex; align-items: center; gap: 8px; }
    .color-preview-text { font-size: 11px; color: var(--text-dim); }
    .ansi-palette { display: none; flex-direction: column; gap: 2px; margin-top: 4px; }
    .ansi-palette.open { display: flex; }
    .ansi-row { display: flex; gap: 2px; }
    .ansi-cell {
      width: 14px;
      height: 14px;
      cursor: pointer;
      border-radius: 2px;
      border: 1px solid transparent;
      transition: border-color 0.1s, transform 0.1s;
    }
    .ansi-cell:hover { border-color: #fff; transform: scale(1.3); z-index: 1; position: relative; }
    .ansi-cell.selected { border-color: #fff; }

    .threshold-row { display: flex; align-items: center; gap: 10px; padding: 8px; background: var(--bg3); border-radius: 4px; }
    .threshold-label { font-size: 11px; min-width: 70px; }

    #output {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    #output-header { display: flex; align-items: center; justify-content: space-between; }

    /* Light mode preview */
    #preview.light-mode { background: #f0ede8; }
    #preview.light-mode .sep-span { color: #aaa !important; }

    /* Theme toggle */
    .theme-toggle { display: flex; gap: 4px; }
    .theme-btn {
      width: 24px;
      height: 24px;
      padding: 0;
      background: transparent;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity 0.3s ease;
    }
    .theme-btn:hover {
      opacity: 0.7;
    }
    #theme-icon {
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Space counter */
    .space-counter { display: flex; align-items: center; gap: 6px; }
    .counter-btn {
      width: 20px; height: 20px;
      background: var(--bg3);
      border: 1px solid var(--border);
      border-radius: 3px;
      font-family: var(--font);
      font-size: 13px;
      color: var(--text-dim);
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0;
      line-height: 1;
    }
    .counter-btn:hover { background: var(--bg4); color: var(--text); }
    .counter-val {
      min-width: 18px;
      text-align: center;
      font-size: 12px;
      color: var(--text);
    }
    #output-code {
      background: #0d0d0d;
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 12px;
      font-size: 11px;
      line-height: 1.6;
      color: #9a9a9a;
      white-space: pre;
      overflow-x: auto;
      max-height: 200px;
      overflow-y: auto;
    }

    /* ‚îÄ‚îÄ‚îÄ Terminal Window Preview ‚îÄ‚îÄ‚îÄ */
    .term-window {
      background: #1e1e1e;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.6), 0 0 0 1px rgba(255,255,255,0.06);
    }
    .term-titlebar {
      background: #2b2b2b;
      height: 38px;
      display: flex;
      align-items: center;
      padding: 0 14px;
      border-bottom: 1px solid #353535;
    }
    .term-dots { display: flex; gap: 8px; align-items: center; }
    .term-dot { width: 13px; height: 13px; border-radius: 50%; }
    .dot-red    { background: #ff5f57; }
    .dot-yellow { background: #ffbd2e; }
    .dot-green  { background: #28c841; }
    .term-title {
      flex: 1;
      text-align: center;
      font-size: 13px;
      color: #888;
      user-select: none;
    }
    .term-body { padding: 20px 24px 16px; }
    .claude-welcome-box {
      border: 1px solid var(--accent);
      border-radius: 4px;
      overflow: hidden;
    }
    .claude-welcome-hdr {
      display: flex;
      align-items: center;
      padding: 8px 14px 0;
      color: var(--accent);
      font-size: 12px;
    }
    .claude-welcome-hdr-line { flex: 1; height: 1px; background: var(--accent); opacity: 0.5; }
    .claude-welcome-hdr-text { padding: 0 8px; white-space: nowrap; }
    .claude-welcome-inner {
      display: grid;
      grid-template-columns: 1fr 1px 1fr;
      padding: 16px 0 12px;
    }
    .claude-left {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 8px 24px 12px;
      gap: 10px;
    }
    .claude-greeting { font-size: 14px; font-weight: 700; color: var(--text); }
    .claude-meta { font-size: 12px; color: var(--text-dim); text-align: center; line-height: 1.7; }
    .claude-divider { background: #3a3a3a; width: 1px; }
    .claude-right {
      padding: 8px 24px 12px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }
    .claude-section-hdr { font-size: 12px; color: var(--accent); font-weight: 600; margin-bottom: 4px; }
    .claude-section-body { font-size: 12px; color: var(--text-dim); line-height: 1.5; }
    .claude-section-sep { height: 1px; background: #3a3a3a; }
    .term-window #preview {
      border: none;
      border-radius: 0;
      padding: 12px 18px;
      background: #1e1e1e;
      min-height: 44px;
      display: flex;
      align-items: center;
    }

    /* Light theme for entire terminal */
    .term-window.light-mode { background: #f0ede8; box-shadow: 0 20px 60px rgba(0,0,0,0.2), 0 0 0 1px rgba(0,0,0,0.08); }
    .term-window.light-mode .term-titlebar { background: #e0ddd8; border-bottom-color: #ccc; }
    .term-window.light-mode .term-title { color: #666; }
    .term-window.light-mode .term-body { background: #f0ede8; }
    .term-window.light-mode .claude-welcome-box { border-color: var(--accent); }
    .term-window.light-mode .claude-greeting { color: #222; }
    .term-window.light-mode .claude-meta { color: #666; }
    .term-window.light-mode .claude-section-body { color: #666; }
    .term-window.light-mode .claude-divider { background: #ccc; }
    .term-window.light-mode .claude-section-sep { background: #ccc; }
    .term-window.light-mode #preview { background: #f0ede8; }
  </style>
</head>
<body>
  <div id="app">
<div class="preview-wrap">
      <div style="margin-bottom:8px"></div>
      <div class="term-window">
        <div class="term-titlebar">
          <div class="term-dots">
            <div class="term-dot dot-red"></div>
            <div class="term-dot dot-yellow"></div>
            <div class="term-dot dot-green"></div>
          </div>
          <div class="term-title">* Claude Code</div>
          <button class="theme-btn" id="theme-toggle" onclick="toggleTheme()" style="width:24px;height:24px;padding:0;border:none;background:transparent;cursor:pointer;display:flex;align-items:center;justify-content:center;">
            <div id="theme-icon"></div>
          </button>
        </div>
        <div class="term-body">
          <div class="claude-welcome-box">
            <div class="claude-welcome-hdr">
              <span class="claude-welcome-hdr-line"></span>
              <span class="claude-welcome-hdr-text">Claude Code</span>
              <span class="claude-welcome-hdr-line"></span>
            </div>
            <div class="claude-welcome-inner">
              <div class="claude-left">
                <div class="claude-greeting">Welcome back!</div>
                <svg width="64" height="76" viewBox="0 0 12 14" xmlns="http://www.w3.org/2000/svg" fill="#e8814d">
                  <rect x="3" y="0" width="1" height="1"/>
                  <rect x="8" y="0" width="1" height="1"/>
                  <rect x="2" y="1" width="8" height="5"/>
                  <rect x="3" y="2" width="2" height="2" fill="#2a1205"/>
                  <rect x="7" y="2" width="2" height="2" fill="#2a1205"/>
                  <rect x="1" y="6" width="10" height="1"/>
                  <rect x="0" y="7" width="2" height="2"/>
                  <rect x="10" y="7" width="2" height="2"/>
                  <rect x="3" y="7" width="6" height="3"/>
                  <rect x="3" y="10" width="2" height="4"/>
                  <rect x="7" y="10" width="2" height="4"/>
                </svg>
                <div class="claude-meta">Sonnet 4.6 ¬∑ Claude Max<br>~/claude</div>
              </div>
              <div class="claude-divider"></div>
              <div class="claude-right">
                <div>
                  <div class="claude-section-hdr">Tips for getting started</div>
                  <div class="claude-section-body">Run /init to create a CLAUDE.md file with ins‚Ä¶</div>
                </div>
                <div class="claude-section-sep"></div>
                <div>
                  <div class="claude-section-hdr">Recent activity</div>
                  <div class="claude-section-body">No recent activity</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div id="preview"></div>
      </div>
    </div>

    <div id="editor">
      <div id="blocks">
        <div class="panel-label">Blocks</div>
        <div id="blocks-list"></div>
      </div>
      <div id="settings">
        <div id="settings-content">
          <div style="color: var(--text-dim); font-size: 12px;">‚Üê –í—ã–±–µ—Ä–∏—Ç–µ –±–ª–æ–∫ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</div>
        </div>
      </div>
    </div>

    <div id="output">
      <div id="output-header">
        <div class="panel-label" style="margin:0">Output: statusline.sh</div>
        <div class="btn-group">
          <button class="btn" onclick="copyScript()">Copy script</button>
          <button class="btn btn-primary" onclick="copyInstallCmd()">Copy install cmd</button>
        </div>
      </div>
      <div id="output-code"></div>
    </div>
  </div>
  <script>
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ANSI 256 COLOR UTILITIES
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function ansiToCSS(n) {
  n = parseInt(n);
  if (n < 16) {
    const base = [
      '#000000','#800000','#008000','#808000',
      '#000080','#800080','#008080','#c0c0c0',
      '#808080','#ff0000','#00ff00','#ffff00',
      '#0000ff','#ff00ff','#00ffff','#ffffff'
    ];
    return base[n];
  }
  if (n >= 232) {
    const v = 8 + (n - 232) * 10;
    return `rgb(${v},${v},${v})`;
  }
  const idx = n - 16;
  const r = Math.floor(idx / 36);
  const g = Math.floor((idx % 36) / 6);
  const b = idx % 6;
  return `rgb(${r?r*40+55:0},${g?g*40+55:0},${b?b*40+55:0})`;
}

function ansiEscape(n) {
  return `\\033[38;5;${n}m`;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// STATE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const DEFAULTS = {
  globalSep: '|',
  globalSepEnabled: true,
  globalSepColor: 243,
  blocks: [
    { id: 'model', name: 'Model', enabled: true, color: 254 },
    { id: 'rate5h', name: 'Rate 5h', enabled: true, style: 'classic', showReset: true, showBar: true, color: 249, colorReset: 238 },
    { id: 'rateWeek', name: 'Rate Week', enabled: true, style: 'classic', showReset: false, showBar: true, color: 249, colorReset: 238 },
    {
      id: 'context', name: 'Context %', enabled: true, showContextTokens: true, contextTokensColor: 243,
      thresholds: [
        { max: 50, color: 82 },
        { max: 80, color: 226 },
        { max: 100, color: 203 },
      ],
    },
    { id: 'tokens', name: 'Tokens', enabled: true, format: '1k', color: 245 },
    { id: 'directory', name: 'Directory', enabled: true, color: 247, depth: 2, showGit: true, colorBranch: 254, colorClean: 247, colorDirty: 203 },
  ]
};

let state = JSON.parse(JSON.stringify(DEFAULTS));

// Ensure all blocks have required properties
state.blocks.forEach(block => {
  if (block.id === 'directory') {
    if (!('showGit' in block)) block.showGit = true;
  }
});
let selectedBlockId = 'rate5h';
let previewTheme = 'dark';

function toggleTheme() {
  previewTheme = previewTheme === 'dark' ? 'light' : 'dark';
  setTheme(previewTheme);
}

function setTheme(t) {
  previewTheme = t;
  const termWindow = document.querySelector('.term-window');
  if (t === 'light') termWindow.classList.add('light-mode');
  else termWindow.classList.remove('light-mode');
  
  // Update icon
  const iconEl = document.getElementById('theme-icon');
  const isDark = t === 'dark';
  iconEl.style.cssText = 'width:16px;height:16px;display:flex;align-items:center;justify-content:center;';
  if (isDark) {
    // Show moon icon for dark mode
    iconEl.innerHTML = '<img src="https://api.iconify.design/line-md:moon-rising-filled-alt-loop.svg?width=16&height=16&color=white" width="16" height="16" alt="Dark mode">';
  } else {
    // Show sun icon for light mode
    iconEl.innerHTML = '<img src="https://api.iconify.design/line-md:moon-filled-alt-to-sunny-filled-loop-transition.svg?width=16&height=16&color=white" width="16" height="16" alt="Light mode">';
  }
}

const MOCK = {
  model: 'Sonnet 4.6',
  contextPercent: 30,
  contextMaxTokens: 200000,
  rate5hPercent: 68,
  rate5hReset: '2h14m',
  rateWeekPercent: 42,
  rateWeekReset: '4d3h',
  inputTokens: 12400,
  outputTokens: 3100,
  cwd: '~/proj/app',
  gitBranch: 'main',
  gitStatus: 'dirty',
  gitAdded: 2,
  gitModified: 1,
  gitUntracked: 0,
};

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// BAR STYLES
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const BAR_STYLES = {
  classic:  { filled: '‚ñì', empty: '‚ñë', name: '–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π' },
  diamond:  { filled: '‚óÜ', empty: '‚óá', name: '–ë—Ä–∏–ª–ª–∏–∞–Ω—Ç' },
  dot:      { filled: '‚óè', empty: '‚óã', name: '–¢–æ—á–∫–∞' },
  line:     { filled: '‚îÅ', empty: '‚îÄ', name: '–õ–∏–Ω–∏—è' },
};

function renderBar(percent, style, length) {
  length = length || 8;
  const cfg = BAR_STYLES[style] || BAR_STYLES.classic;
  const filled = Math.round((percent / 100) * length);
  const empty = length - filled;
  let bar = '';

  if (style === 'gradient') {
    for (let i = 0; i < filled; i++) {
      const ratio = i / length;
      bar += ratio < 0.4 ? '‚ñà' : ratio < 0.7 ? '‚ñì' : '‚ñí';
    }
    for (let i = 0; i < empty; i++) bar += '‚ñë';
  } else if (style === 'emoji') {
    const fc = percent < 50 ? 'üü¢' : percent < 80 ? 'üü°' : 'üî¥';
    for (let i = 0; i < filled; i++) bar += fc;
    for (let i = 0; i < empty; i++) bar += '‚ö™';
  } else {
    for (let i = 0; i < filled; i++) bar += cfg.filled;
    for (let i = 0; i < empty; i++) bar += cfg.empty;
  }
  return bar;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// PREVIEW RENDERER
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function getContextColor(percent) {
  const block = state.blocks.find(b => b.id === 'context');
  if (!block) return '#4ec94e';
  for (const t of block.thresholds) {
    if (percent <= t.max) return ansiToCSS(t.color);
  }
  return ansiToCSS(block.thresholds[block.thresholds.length - 1].color);
}

function formatTokens(n, fmt) {
  if (fmt === '1000') return n.toString();
  if (fmt === '1.2k') return (n / 1000).toFixed(1) + 'k';
  return Math.floor(n / 1000) + 'k';
}

// Colored bar for preview (filled portion changes color by percent)
function renderColoredBar(percent, style, length, fillColorOverride) {
  length = length || 8;
  const filled = Math.round((percent / 100) * length);
  const empty = length - filled;
  const fillColor = fillColorOverride || (percent < 50 ? '#4ec94e' : percent < 80 ? '#e8c44d' : '#e84d4d');
  const emptyColor = previewTheme === 'light' ? '#bbb' : '#444';

  if (style === 'emoji') {
    const fc = percent < 50 ? 'üü¢' : percent < 80 ? 'üü°' : 'üî¥';
    return (fc.repeat(filled)) + ('‚ö™'.repeat(empty));
  }

  const cfg = BAR_STYLES[style] || BAR_STYLES.classic;
  let filledStr = '';
  if (style === 'gradient') {
    for (let i = 0; i < filled; i++) {
      const r = i / length;
      filledStr += r < 0.4 ? '‚ñà' : r < 0.7 ? '‚ñì' : '‚ñí';
    }
  } else {
    filledStr = cfg.filled.repeat(filled);
  }
  const emptyStr = cfg.empty.repeat(empty);

  return `<span style="letter-spacing:0;line-height:1;vertical-align:middle">`
       + (filledStr ? `<span style="color:${fillColor}">${filledStr}</span>` : '')
       + (emptyStr  ? `<span style="color:${emptyColor}">${emptyStr}</span>` : '')
       + `</span>`;
}

function renderPreview() {
  const preview = document.getElementById('preview');
  const parts = [];

  const isDark = previewTheme === 'dark';
  const sepColor = isDark ? '#555' : '#aaa';
  const sepUserColor = ansiToCSS(state.globalSepColor);
  const sep = (ch) => `<span style="color:${sepUserColor}">&nbsp;${ch}&nbsp;</span>`;
  const spaces = (n) => n > 0 ? '&nbsp;'.repeat(n) : '';

  let isFirst = true;
  for (const block of state.blocks) {
    if (!block.enabled) continue;

    if (!isFirst) parts.push(state.globalSepEnabled && state.globalSep ? sep(state.globalSep) : '&nbsp;');
    isFirst = false;

    switch (block.id) {
      case 'model':
        parts.push(`<span style="color:${ansiToCSS(block.color)}">[${MOCK.model}]</span>`);
        break;
      case 'context': {
        let html = `<span style="color:${getContextColor(MOCK.contextPercent)}"> ${MOCK.contextPercent}%</span>`;
        if (block.showContextTokens) {
          const usedTokens = Math.round(MOCK.contextMaxTokens * MOCK.contextPercent / 100 / 1000) + 'K';
          const maxTokens = Math.round(MOCK.contextMaxTokens / 1000) + 'K';
          html += `&nbsp;<span style="color:${ansiToCSS(block.contextTokensColor)}">(${usedTokens}/${maxTokens})</span>`;
        }
        parts.push(html);
        break;
      }
      case 'rate5h': {
        const rateColor = ansiToCSS(block.color);
        let s = '';
        if (block.showBar) {
          const bar = renderColoredBar(MOCK.rate5hPercent, block.style, 8, rateColor);
          s += bar + '&nbsp;';
        }
        s += `<span style="color:${rateColor}">h${MOCK.rate5hPercent}%</span>`;
        if (block.showReset) s += `&nbsp;<span style="color:${ansiToCSS(block.colorReset ?? 238)}">${MOCK.rate5hReset}</span>`;
        parts.push(s);
        break;
      }
      case 'rateWeek': {
        const rateColor = ansiToCSS(block.color);
        let s = '';
        if (block.showBar) {
          const bar = renderColoredBar(MOCK.rateWeekPercent, block.style, 8, rateColor);
          s += bar + '&nbsp;';
        }
        s += `<span style="color:${rateColor}">w${MOCK.rateWeekPercent}%</span>`;
        if (block.showReset) s += `&nbsp;<span style="color:${ansiToCSS(block.colorReset ?? 238)}">${MOCK.rateWeekReset}</span>`;
        parts.push(s);
        break;
      }
      case 'tokens':
        parts.push(`<span style="color:${ansiToCSS(block.color)}">‚Üë${formatTokens(MOCK.inputTokens, block.format)} ‚Üì${formatTokens(MOCK.outputTokens, block.format)}</span>`);
        break;
      case 'directory': {
        let dirHtml = `<span style="color:${ansiToCSS(block.color)}">${MOCK.cwd}</span>`;
        if (block.showGit ?? true) {
          const branchColor = ansiToCSS(block.colorBranch);
          const statusColor = MOCK.gitStatus === 'clean' ? ansiToCSS(block.colorClean) : ansiToCSS(block.colorDirty);
          dirHtml += ` <span style="color:${branchColor}">(${MOCK.gitBranch})</span>`;
        }
        parts.push(dirHtml);
        break;
      }
    }
  }

  preview.innerHTML = parts.join('');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// RENDER (–±—É–¥–µ—Ç –¥–æ–ø–æ–ª–Ω–µ–Ω –≤ Task 3-6)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// BLOCKS PANEL
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

let dragSrcIdx = null;

function renderBlocks() {
  const list = document.getElementById('blocks-list');
  list.innerHTML = '';

  state.blocks.forEach((block, idx) => {
    const item = document.createElement('div');
    item.className = 'block-item' +
      (block.id === selectedBlockId ? ' active' : '') +
      (!block.enabled ? ' disabled' : '');
    item.draggable = true;
    item.dataset.idx = idx;

    item.innerHTML = `
      <span class="drag-handle" title="–ü–µ—Ä–µ—Ç–∞—â–∏—Ç—å">‚†ø</span>
      <span class="block-toggle ${block.enabled ? 'on' : ''}" data-id="${block.id}">
        ${block.enabled ? '‚úì' : ''}
      </span>
      <span class="block-name">${block.name}</span>
    `;

    // –ö–ª–∏–∫ –ø–æ —ç–ª–µ–º–µ–Ω—Ç—É ‚Äî –≤—ã–±–æ—Ä –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    item.addEventListener('click', (e) => {
      if (e.target.classList.contains('block-toggle')) return;
      selectedBlockId = block.id;
      render();
setTheme(previewTheme);  // Initialize theme icon
    });

    // –ö–ª–∏–∫ –ø–æ toggle ‚Äî –≤–∫–ª/–≤—ã–∫–ª
    item.querySelector('.block-toggle').addEventListener('click', (e) => {
      e.stopPropagation();
      block.enabled = !block.enabled;
      render();
    });

    // Drag & Drop
    item.addEventListener('dragstart', (e) => {
      dragSrcIdx = idx;
      e.dataTransfer.effectAllowed = 'move';
      setTimeout(() => item.style.opacity = '0.5', 0);
    });
    item.addEventListener('dragend', () => {
      item.style.opacity = '';
      document.querySelectorAll('.block-item').forEach(el => el.classList.remove('drag-over'));
    });
    item.addEventListener('dragover', (e) => {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      document.querySelectorAll('.block-item').forEach(el => el.classList.remove('drag-over'));
      item.classList.add('drag-over');
    });
    item.addEventListener('dragleave', () => item.classList.remove('drag-over'));
    item.addEventListener('drop', (e) => {
      e.preventDefault();
      item.classList.remove('drag-over');
      if (dragSrcIdx === null || dragSrcIdx === idx) return;
      const moved = state.blocks.splice(dragSrcIdx, 1)[0];
      state.blocks.splice(idx, 0, moved);
      dragSrcIdx = null;
      render();
    });

    list.appendChild(item);
  });

  const sepDivider = document.createElement('div');
  sepDivider.style.cssText = 'height:1px;background:var(--border);margin:6px 0 2px';
  list.appendChild(sepDivider);

  const sepItem = document.createElement('div');
  sepItem.className = 'block-item' + (selectedBlockId === '_sep' ? ' active' : '');
  sepItem.innerHTML = `
    <span class="block-toggle ${state.globalSepEnabled ? 'on' : ''}" data-id="_sep">
      ${state.globalSepEnabled ? '‚úì' : ''}
    </span>
    <span class="block-name">–†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å</span>
  `;

  sepItem.addEventListener('click', (e) => {
    if (e.target.classList.contains('block-toggle')) return;
    selectedBlockId = '_sep';
    render();
  });

  sepItem.querySelector('.block-toggle').addEventListener('click', (e) => {
    e.stopPropagation();
    state.globalSepEnabled = !state.globalSepEnabled;
    render();
  });

  list.appendChild(sepItem);
}
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ANSI COLOR PICKER
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function buildAnsiPalette(currentCode, onChange) {
  const wrap = document.createElement('div');
  wrap.className = 'color-picker-wrap';

  const previewRow = document.createElement('div');
  previewRow.className = 'color-preview-row';

  const swatch = document.createElement('div');
  swatch.className = 'color-swatch';
  swatch.style.background = ansiToCSS(currentCode);
  swatch.title = '–ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å/–∑–∞–∫—Ä—ã—Ç—å –ø–∞–ª–∏—Ç—Ä—É';

  const label = document.createElement('span');
  label.className = 'color-preview-text';
  label.textContent = `ANSI ${currentCode}`;

  previewRow.appendChild(swatch);
  previewRow.appendChild(label);
  wrap.appendChild(previewRow);

  const palette = document.createElement('div');
  palette.className = 'ansi-palette';

  function makeCell(code) {
    const cell = document.createElement('div');
    cell.className = 'ansi-cell' + (code === currentCode ? ' selected' : '');
    cell.style.background = ansiToCSS(code);
    cell.title = `ANSI ${code}`;
    cell.addEventListener('click', () => {
      onChange(code);
      palette.classList.remove('open');
    });
    return cell;
  }

  // Base 16 colors (2 rows of 8)
  const row1 = document.createElement('div'); row1.className = 'ansi-row';
  const row2 = document.createElement('div'); row2.className = 'ansi-row';
  for (let i = 0; i < 8; i++) row1.appendChild(makeCell(i));
  for (let i = 8; i < 16; i++) row2.appendChild(makeCell(i));
  palette.appendChild(row1);
  palette.appendChild(row2);

  // Spacer
  const s1 = document.createElement('div'); s1.style.height = '4px';
  palette.appendChild(s1);

  // 216 color cube
  for (let r = 0; r < 6; r++) {
    const row = document.createElement('div');
    row.className = 'ansi-row';
    for (let g = 0; g < 6; g++) {
      for (let b = 0; b < 6; b++) {
        row.appendChild(makeCell(16 + r * 36 + g * 6 + b));
      }
    }
    palette.appendChild(row);
  }

  // Spacer
  const s2 = document.createElement('div'); s2.style.height = '4px';
  palette.appendChild(s2);

  // Grayscale
  const grayRow = document.createElement('div'); grayRow.className = 'ansi-row';
  for (let i = 232; i < 256; i++) grayRow.appendChild(makeCell(i));
  palette.appendChild(grayRow);

  wrap.appendChild(palette);
  swatch.addEventListener('click', () => palette.classList.toggle('open'));
  return wrap;
}

function buildToggle(checked, label, onChange) {
  const wrap = document.createElement('div');
  wrap.className = 'toggle-wrap';
  wrap.innerHTML = `
    <label class="toggle">
      <input type="checkbox" ${checked ? 'checked' : ''}>
      <span class="toggle-slider"></span>
    </label>
    <span class="toggle-text">${label}</span>
  `;
  wrap.querySelector('input').addEventListener('change', (e) => onChange(e.target.checked));
  return wrap;
}

function buildSegment(options, current, onChange) {
  const seg = document.createElement('div');
  seg.className = 'segment';
  options.forEach(opt => {
    const btn = document.createElement('button');
    btn.className = 'segment-btn' + (opt.value == current ? ' active' : '');
    btn.textContent = opt.label;
    btn.addEventListener('click', () => onChange(opt.value));
    seg.appendChild(btn);
  });
  return seg;
}

function buildRow(label, content) {
  const row = document.createElement('div');
  row.className = 'setting-row';
  const lbl = document.createElement('div');
  lbl.className = 'setting-label';
  lbl.textContent = label;
  row.appendChild(lbl);
  row.appendChild(content);
  return row;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// SETTINGS PANEL
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function renderSettings() {
  const content = document.getElementById('settings-content');
  if (!content) return;

  if (selectedBlockId === '_sep') {
    content.innerHTML = `<div class="settings-title">–†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å</div>`;
    content.appendChild(buildRow('–°—Ç–∏–ª—å',
      buildSegment(SEP_OPTIONS, state.globalSep, v => { state.globalSep = v; render(); })
    ));
    content.appendChild(buildRow('–¶–≤–µ—Ç',
      buildAnsiPalette(state.globalSepColor, v => { state.globalSepColor = v; render(); })
    ));
    return;
  }

  const block = state.blocks.find(b => b.id === selectedBlockId);

  if (!block) {
    content.innerHTML = '<div style="color: var(--text-dim); font-size: 12px;">‚Üê –í—ã–±–µ—Ä–∏—Ç–µ –±–ª–æ–∫ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</div>';
    return;
  }

  content.innerHTML = `<div class="settings-title">${block.name}</div>`;

  switch (block.id) {
    case 'model':      renderModelSettings(content, block); break;
    case 'context':    renderContextSettings(content, block); break;
    case 'rate5h':
    case 'rateWeek':   renderRateSettings(content, block); break;
    case 'tokens':     renderTokensSettings(content, block); break;
    case 'directory':  renderDirectorySettings(content, block); break;
  }
}

const SEP_OPTIONS = [{value:'|',label:'|'},{value:'¬∑',label:'¬∑'},{value:'‚Äî',label:'‚Äî'},{value:'',label:'–Ω–µ—Ç'}];

function buildCounter(value, min, max, onChange) {
  const wrap = document.createElement('div');
  wrap.className = 'space-counter';
  const minus = document.createElement('button');
  minus.className = 'counter-btn';
  minus.textContent = '‚àí';
  const val = document.createElement('span');
  val.className = 'counter-val';
  val.textContent = value;
  const plus = document.createElement('button');
  plus.className = 'counter-btn';
  plus.textContent = '+';
  minus.addEventListener('click', () => {
    if (value > min) { value--; val.textContent = value; onChange(value); }
  });
  plus.addEventListener('click', () => {
    if (value < max) { value++; val.textContent = value; onChange(value); }
  });
  wrap.appendChild(minus);
  wrap.appendChild(val);
  wrap.appendChild(plus);
  return wrap;
}

function renderModelSettings(el, block) {
  el.appendChild(buildRow('–¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞',
    buildAnsiPalette(block.color, v => { block.color = v; render();
  })
  ));
}

function renderContextSettings(el, block) {
  const section = document.createElement('div');
  section.className = 'setting-row';
  const sectionLabel = document.createElement('div');
  sectionLabel.className = 'setting-label';
  sectionLabel.textContent = '–¶–≤–µ—Ç–∞ –ø–æ –ø–æ—Ä–æ–≥–∞–º';
  section.appendChild(sectionLabel);

  const labels = ['0 ‚Äì 49%', '50 ‚Äì 79%', '80 ‚Äì 100%'];
  block.thresholds.forEach((t, i) => {
    const row = document.createElement('div');
    row.className = 'threshold-row';
    const lbl = document.createElement('span');
    lbl.className = 'threshold-label';
    lbl.textContent = labels[i];
    row.appendChild(lbl);
    row.appendChild(buildAnsiPalette(t.color, v => { t.color = v; render();
  }));
    section.appendChild(row);
  });
  el.appendChild(section);

  const spacer1 = document.createElement('div');
  spacer1.style.height = '8px';
  el.appendChild(spacer1);

  el.appendChild(buildRow('–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å (K/K)',
    buildToggle(block.showContextTokens, '–†–∞–∑–º–µ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞', v => { block.showContextTokens = v; render();
  })
  ));

  if (block.showContextTokens) {
    el.appendChild(buildRow('–¶–≤–µ—Ç (K/K)',
      buildAnsiPalette(block.contextTokensColor, v => { block.contextTokensColor = v; render();
  })
    ));
  }
}

function renderRateSettings(el, block) {
  const spacerRate = document.createElement('div');
  spacerRate.style.height = '8px';
  el.appendChild(spacerRate);

  el.appendChild(buildRow('–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —à–∫–∞–ª—É',
    buildToggle(block.showBar, '–®–∫–∞–ª–∞ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤', v => { block.showBar = v; render();
  })
  ));

  const cardsRow = document.createElement('div');
  cardsRow.className = 'setting-row';
  const cardsLabel = document.createElement('div');
  cardsLabel.className = 'setting-label';
  cardsLabel.textContent = '–°—Ç–∏–ª—å —à–∫–∞–ª—ã';
  cardsRow.appendChild(cardsLabel);

  const cards = document.createElement('div');
  cards.className = 'style-cards';
  Object.entries(BAR_STYLES).forEach(([key, cfg]) => {
    const card = document.createElement('div');
    card.className = 'style-card' + (block.style === key ? ' active' : '');
    const preview = renderBar(60, key, 6);
    card.innerHTML = `<div class="style-card-preview">${preview}</div><div class="style-card-name">${cfg.name}</div>`;
    card.addEventListener('click', () => { block.style = key; render();
  });
    cards.appendChild(card);
  });
  cardsRow.appendChild(cards);
  el.appendChild(cardsRow);

  el.appendChild(buildRow('–¶–≤–µ—Ç —à–∫–∞–ª—ã',
    buildAnsiPalette(block.color, v => { block.color = v; render();
  })
  ));

  const spacerReset = document.createElement('div');
  spacerReset.style.height = '8px';
  el.appendChild(spacerReset);

  el.appendChild(buildRow('–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å "–¥–æ —Å–±—Ä–æ—Å–∞"',
    buildToggle(block.showReset, '–í—Ä–µ–º—è –¥–æ —Å–±—Ä–æ—Å–∞', v => { block.showReset = v; render();
  })
  ));
  if (block.showReset) {
    el.appendChild(buildRow('–¶–≤–µ—Ç —Ç–∞–π–º–µ—Ä–∞',
      buildAnsiPalette(block.colorReset ?? 238, v => { block.colorReset = v; render();
  })
    ));
  }
}

function renderTokensSettings(el, block) {
  el.appendChild(buildRow('–§–æ—Ä–º–∞—Ç —á–∏—Å–ª–∞',
    buildSegment(
      [{value:'1k',label:'12k'},{value:'1.2k',label:'12.4k'},{value:'1000',label:'12400'}],
      block.format,
      v => { block.format = v; render();
}
    )
  ));
  el.appendChild(buildRow('–¶–≤–µ—Ç',
    buildAnsiPalette(block.color, v => { block.color = v; render();
  })
  ));
}

function renderDirectorySettings(el, block) {
  el.appendChild(buildRow('–ì–ª—É–±–∏–Ω–∞ –ø—É—Ç–∏',
    buildSegment(
      [{value:1,label:'app'},{value:2,label:'proj/app'},{value:0,label:'–ø–æ–ª–Ω—ã–π'}],
      block.depth,
      v => { block.depth = parseInt(v); render();
}
    )
  ));
  el.appendChild(buildRow('–¶–≤–µ—Ç',
    buildAnsiPalette(block.color, v => { block.color = v; render();
  })
  ));

  // Git section
  const gitDiv = document.createElement('div');
  gitDiv.style.cssText = 'height:1px;background:var(--border);margin:8px 0 2px';
  el.appendChild(gitDiv);

  el.appendChild(buildRow('Git',
    buildToggle(block.showGit ?? true, 'Git', v => { block.showGit = v; render();
  })
  ));

  if (block.showGit ?? true) {
    el.appendChild(buildRow('–¶–≤–µ—Ç –≤–µ—Ç–∫–∏',
      buildAnsiPalette(block.colorBranch, v => { block.colorBranch = v; render();
  })
    ));


  }
}

function renderOutput() {
  const el = document.getElementById('output-code');
  if (el) el.textContent = generateScript();
}

function render() {
  renderPreview();
  renderBlocks();
  renderSettings();
  renderOutput();
}

function copyScript() {
  navigator.clipboard.writeText(generateScript()).then(() => {
    document.querySelectorAll('.btn').forEach(b => {
      if (b.textContent === 'Copy script') {
        b.textContent = '‚úì Copied!';
        setTimeout(() => b.textContent = 'Copy script', 1500);
      }
    });
  });
}

function copyInstallCmd() {
  const script = generateScript();
  const b64 = btoa(unescape(encodeURIComponent(script)));
  const cmd = `mkdir -p ~/.claude && echo '${b64}' | base64 -d > ~/.claude/statusline.sh && chmod +x ~/.claude/statusline.sh && echo '‚úì Done'`;
  navigator.clipboard.writeText(cmd).then(() => {
    document.querySelectorAll('.btn-primary').forEach(b => {
      if (b.textContent === 'Copy install cmd') {
        b.textContent = '‚úì Copied!';
        setTimeout(() => b.textContent = 'Copy install cmd', 2000);
      }
    });
  });
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// SCRIPT GENERATOR
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function generateScript() {
  const lines = [];
  lines.push('#!/bin/bash');
  lines.push('# Statusline ‚Äî generated by statusline-editor.html v2');
  lines.push('');
  lines.push('JSON_INPUT=$(cat)');
  lines.push('');
  lines.push('model=$(echo "$JSON_INPUT" | jq -r \'.model.display_name // "Claude"\' | sed \'s/^Claude //\')');
  lines.push('input=$(echo "$JSON_INPUT" | jq -r \'.context_window.total_input_tokens // 0\')');
  lines.push('output=$(echo "$JSON_INPUT" | jq -r \'.context_window.total_output_tokens // 0\')');
  lines.push('percent=$(echo "$JSON_INPUT" | jq -r \'.context_window.used_percentage // 0\')');
  lines.push('cwd=$(echo "$JSON_INPUT" | jq -r \'.cwd // (.workspace.current_dir // "")\')');
  lines.push('');
  lines.push('RESET="\\033[0m"');
  if (state.globalSepEnabled && state.globalSep) {
    lines.push(`SEP_COLOR="\\033[38;5;${state.globalSepColor}m"`);
  }

  state.blocks.forEach(block => {
    if (!block.enabled) return;
    switch (block.id) {
      case 'model':
        lines.push(`MODEL_COLOR="\\033[38;5;${block.color}m"`);
        break;
      case 'context':
        lines.push(`CTX_LOW="\\033[38;5;${block.thresholds[0].color}m"`);
        lines.push(`CTX_MID="\\033[38;5;${block.thresholds[1].color}m"`);
        lines.push(`CTX_HIGH="\\033[38;5;${block.thresholds[2].color}m"`);
        break;
      case 'rate5h':
        lines.push(`RATE5H_COLOR="\\033[38;5;${block.color}m"`);
        break;
      case 'rateWeek':
        lines.push(`RATEWEEK_COLOR="\\033[38;5;${block.color}m"`);
        break;
      case 'tokens':
        lines.push(`TOKEN_COLOR="\\033[38;5;${block.color}m"`);
        break;
      case 'directory':
        lines.push(`DIR_COLOR="\\033[38;5;${block.color}m"`);
        if (block.showGit) {
          lines.push(`GIT_COLOR="\\033[38;5;${block.colorBranch}m"`);
          lines.push(`GIT_CLEAN="\\033[38;5;${block.colorClean}m"`);
          lines.push(`GIT_DIRTY="\\033[38;5;${block.colorDirty}m"`);
        }
        break;
    }
  });

  lines.push('');

  // Bar function if rate blocks enabled
  const hasRate = state.blocks.some(b => (b.id === 'rate5h' || b.id === 'rateWeek') && b.enabled);
  if (hasRate) {
    const rateBlock = state.blocks.find(b => (b.id === 'rate5h' || b.id === 'rateWeek') && b.enabled);
    const style = rateBlock ? rateBlock.style : 'classic';
    if (style === 'emoji') {
      lines.push('get_rate_bar() {');
      lines.push('  local p=$1 len=${2:-8} bar=""');
      lines.push('  local filled=$(( p * len / 100 ))');
      lines.push('  local empty=$(( len - filled ))');
      lines.push('  local fc; if (( p < 50 )); then fc="üü¢"; elif (( p < 80 )); then fc="üü°"; else fc="üî¥"; fi');
      lines.push('  for ((i=0;i<filled;i++)); do bar+="$fc"; done');
      lines.push('  for ((i=0;i<empty;i++)); do bar+="‚ö™"; done');
      lines.push('  echo "$bar"');
      lines.push('}');
    } else if (style === 'gradient') {
      lines.push('get_rate_bar() {');
      lines.push('  local p=$1 len=${2:-8} bar=""');
      lines.push('  local filled=$(( p * len / 100 ))');
      lines.push('  local empty=$(( len - filled ))');
      lines.push('  for ((i=0;i<filled;i++)); do');
      lines.push('    local ratio=$(( i * 10 / len ))');
      lines.push('    if (( ratio < 4 )); then bar+="‚ñà"; elif (( ratio < 7 )); then bar+="‚ñì"; else bar+="‚ñí"; fi');
      lines.push('  done');
      lines.push('  for ((i=0;i<empty;i++)); do bar+="‚ñë"; done');
      lines.push('  echo "$bar"');
      lines.push('}');
    } else {
      const cfg = BAR_STYLES[style] || BAR_STYLES.classic;
      lines.push(`RATE_FILLED="${cfg.filled}"`);
      lines.push(`RATE_EMPTY="${cfg.empty}"`);
      lines.push('get_rate_bar() {');
      lines.push('  local p=$1 len=${2:-8} bar=""');
      lines.push('  local filled=$(( p * len / 100 ))');
      lines.push('  local empty=$(( len - filled ))');
      lines.push('  for ((i=0;i<filled;i++)); do bar+="${RATE_FILLED}"; done');
      lines.push('  for ((i=0;i<empty;i++)); do bar+="${RATE_EMPTY}"; done');
      lines.push('  echo "$bar"');
      lines.push('}');
    }
    lines.push('');
  }

  // Directory function
  const dirBlock = state.blocks.find(b => b.id === 'directory' && b.enabled);
  lines.push('get_directory() {');
  if (dirBlock && dirBlock.depth === 0) {
    lines.push('  echo "$1"');
  } else if (dirBlock && dirBlock.depth === 1) {
    lines.push('  echo "$(basename "$1")"');
  } else {
    lines.push('  local parent=$(basename "$(dirname "$1")")');
    lines.push('  local current=$(basename "$1")');
    lines.push('  if [[ "$parent" == "/" || -z "$parent" ]]; then echo "~/${current}"; else echo "~/${parent}/${current}"; fi');
  }
  lines.push('}');
  lines.push('');

  // Git helpers
  const gitBlock = state.blocks.find(b => b.id === 'git' && b.enabled);
  if (gitBlock) {
    lines.push('get_git_branch() { git -C "$1" rev-parse --abbrev-ref HEAD 2>/dev/null; }');
    lines.push('get_git_status() {');
    lines.push('  git -C "$1" diff --quiet 2>/dev/null && git -C "$1" diff --cached --quiet 2>/dev/null && echo clean || echo dirty');
    lines.push('}');
    lines.push('');
  }

  // Token format
  const tokBlock = state.blocks.find(b => b.id === 'tokens' && b.enabled);
  if (tokBlock) {
    if (tokBlock.format === '1000') {
      lines.push('format_tokens() { echo "$1"; }');
    } else if (tokBlock.format === '1.2k') {
      lines.push('format_tokens() { printf "%.1fk" "$(echo "scale=1; $1/1000" | bc)"; }');
    } else {
      lines.push('format_tokens() { echo $(($1 / 1000)); }');
    }
    lines.push('');
  }

  // Context color
  const ctxBlock = state.blocks.find(b => b.id === 'context' && b.enabled);
  if (ctxBlock) {
    lines.push('get_ctx_color() {');
    lines.push('  local p=$1');
    lines.push(`  if (( p < ${ctxBlock.thresholds[1].max} )); then echo -e "$CTX_LOW"`);
    lines.push(`  elif (( p < ${ctxBlock.thresholds[2].max} )); then echo -e "$CTX_MID"`);
    lines.push('  else echo -e "$CTX_HIGH"');
    lines.push('  fi');
    lines.push('}');
    lines.push('');
  }

  // Compute values
  lines.push('# ‚îÄ‚îÄ Compute values ‚îÄ‚îÄ');
  lines.push('directory=$(get_directory "$cwd")');
  if (tokBlock) {
    lines.push('input_k=$(format_tokens "$input")');
    lines.push('output_k=$(format_tokens "$output")');
  }
  if (ctxBlock) {
    lines.push('ctx_color=$(get_ctx_color "$percent")');
  }
  lines.push('');

  // Print statusline
  lines.push('# ‚îÄ‚îÄ Print statusline ‚îÄ‚îÄ');
  let firstBlock = true;
  for (const block of state.blocks) {
    if (!block.enabled) continue;
    if (!firstBlock && state.globalSepEnabled && state.globalSep) {
      lines.push(`printf "\${SEP_COLOR}${state.globalSep}\${RESET} "`);
    }
    firstBlock = false;
    switch (block.id) {
      case 'model':
        lines.push(`printf "\${MODEL_COLOR}[%s]\${RESET} " "$model"`);
        break;
      case 'context':
        if (block.showContextTokens) {
          lines.push(`CTX_MAX=200000  # Max context tokens for current model`);
          lines.push(`used_tokens=$((CTX_MAX * percent / 100 / 1000))`);
          lines.push(`max_tokens=$((CTX_MAX / 1000))`);
          lines.push(`printf "\${ctx_color} %s%%\${RESET} \${CTX_TOKENS_COLOR}(%sK/%sK)\${RESET} " "$percent" "$used_tokens" "$max_tokens"`);
        } else {
          lines.push(`printf "\${ctx_color} %s%%\${RESET} " "$percent"`);
        }
        break;
      case 'rate5h':
        lines.push('# rate5h: requires rate limit data in JSON input');
        lines.push('# rate5h_pct=$(echo "$JSON_INPUT" | jq -r \'.rate_limits.five_hour_pct // 0\')');
        if (block.showReset) {
          lines.push('# rate5h_reset=$(echo "$JSON_INPUT" | jq -r \'.rate_limits.five_hour_reset // ""\')');
          lines.push('# printf "${RATE5H_COLOR}%s %s%%" "$(get_rate_bar $rate5h_pct)" "$rate5h_pct"');
          lines.push('# [[ -n "$rate5h_reset" ]] && printf " \\033[38;5;238m%s${RESET}" "$rate5h_reset"');
          lines.push('# printf " ${RESET}"');
        } else {
          lines.push('# printf "${RATE5H_COLOR}%s %s%%${RESET} " "$(get_rate_bar $rate5h_pct)" "$rate5h_pct"');
        }
        break;
      case 'rateWeek':
        lines.push('# rateWeek: requires rate limit data in JSON input');
        lines.push('# rate_week_pct=$(echo "$JSON_INPUT" | jq -r \'.rate_limits.week_pct // 0\')');
        if (block.showReset) {
          lines.push('# rate_week_reset=$(echo "$JSON_INPUT" | jq -r \'.rate_limits.week_reset // ""\')');
          lines.push('# printf "${RATEWEEK_COLOR}%s %s%%" "$(get_rate_bar $rate_week_pct)" "$rate_week_pct"');
          lines.push('# [[ -n "$rate_week_reset" ]] && printf " \\033[38;5;238m%s${RESET}" "$rate_week_reset"');
          lines.push('# printf " ${RESET}"');
        } else {
          lines.push('# printf "${RATEWEEK_COLOR}W%s %%${RESET} " "$rate_week_pct"');
        }
        break;
      case 'tokens':
        lines.push(`printf "\${TOKEN_COLOR}‚Üë%s ‚Üì%s\${RESET} " "$input_k" "$output_k"`);
        break;
      case 'directory':
        lines.push(`printf "\${DIR_COLOR}%s\${RESET}" "$directory"`);
        if (block.showGit) {
          lines.push('if [[ -n "$cwd" ]]; then');
          lines.push('  git_branch=$(get_git_branch "$cwd")');
          lines.push('  if [[ -n "$git_branch" ]]; then');
          lines.push('    git_status=$(get_git_status "$cwd")');
          lines.push('    printf " \${GIT_COLOR}(%s)\${RESET}" "$git_branch"');

          lines.push('  fi');
          lines.push('fi');
        }
        break;
    }
    lines.push(`printf " "`);
  }

  lines.push('');
  return lines.join('\n');
}

render();
setTheme(previewTheme);
</script>
</body>
</html>
